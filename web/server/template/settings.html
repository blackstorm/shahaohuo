<!doctype html>
<html lang="zh-CN">
<head>
    {{ template "head"}}
    <title>设置 - 啥好货</title>
    <style>
        .title {
            padding-top: 4rem;
            padding-bottom: 2rem;
        }
        .avatar {
            max-width: 64px;
            padding-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div id="root">
        <div class="wrapper">
            {{ template "nav" }}
            <div class="container">
                <div id="settings">
                    <div class="row">
                        <div class="col-md-4">
                            <h4 class="title main-color">基础设置</h4>
                            <form id="disabled-form">
                                <div class="form-group">
                                    <label for="id">用户ID</label>
                                    <input name="id" id="id" type="text" class="form-control" min="1" maxlength="12" value="{{ .User.Id}}" disabled>
                                </div>
                            </form>
                            <form id="basic-form">
                                <div class="form-group">
                                    <label for="id">头像</label>
                                    <img id="avatar" src="{{ .User.Avatar }}" class="rounded d-block avatar" alt="{{ .User.Name }}">
                                    <input type="file" class="form-control-file" id="image" name="image" placeholder="选择一张图片作为你的头像">
                                </div>
                                <div class="form-group">
                                    <label for="name">用户昵称</label>
                                    <input name="name" id="name" type="text" class="form-control" value="{{ .User.Name }}">
                                </div>
                                <div class="form-group">
                                    <label for="bio">个人介绍</label>
                                    <textarea class="form-control" id="bio" name="bio" rows="3" maxlength="266" placeholder="生动下描述自己">{{ .User.Bio }}</textarea>
                                </div>
                                <button type="submit" id="submit-btn" class="btn btn-main">保存</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            {{template "footer" }}
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery-validation@1.19.1/dist/jquery.validate.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery-validation@1.19.1/dist/additional-methods.min.js"></script>
    <script src="/static/nav.js"></script>
    <script>
        $(function () {
            settingsApi = {
                uploadAvatar: function (data, success, error) {
                    const user = $user();
                    $.ajax({
                        type: "POST",
                        url: "/api/v1/images/upload?t=avatar",
                        headers: {"Authorization": "Bearer " + user.token},
                        enctype: 'multipart/form-data',
                        processData: false,
                        contentType: false,
                        cache: false,
                        data: data,
                        success: success,
                        error: error
                    });
                },
                patchUser: function (data, success, error) {
                    const user = $user();
                    $.ajax({
                        type: "PATCH",
                        url: "/api/v1/users",
                        headers: {"Authorization": "Bearer " + user.token},
                        contentType: "application/json",
                        data: JSON.stringify(data),
                        success: success,
                        error: error
                    });
                }
            };
            // image preview
            $("#image").change(function(){
                var input = this;
                if (input.files && input.files[0]) {
                    var reader = new FileReader();
                    reader.onload = function (e) {
                        $('#avatar').attr('src', e.target.result);
                    };
                    reader.readAsDataURL(input.files[0]);
                }
            });
            // validate addons
            $.validator.addMethod('filesize', function (value, element, arg) {
                if (element.files && element.files[0]) {
                    return element.files[0].size <= arg;
                }
                return true
            });
            $("#basic-form").validate({
                rules: {
                    name: {
                        required: true,
                        minlength: 1,
                        maxlength: 12
                    },
                    bio: {
                        required: false,
                        maxlength: 128,
                    },
                    image: {
                        required: false,
                        accept:"image/jpeg,image/png",
                        filesize: 4 << 20
                    }
                },
                messages: {
                    name: {
                        minlength: "名称最小长度为1",
                        maxlength: "名称最大长度为12"
                    },
                    bio: {
                        maxlength: "个人简介超出限制",
                    },
                    image: {
                        accept: "请选择JPG或PNG类型的图片",
                        filesize: "选择的图片请不要超过4m",
                    },
                },
                submitHandler: function(form, event) {
                    event.preventDefault();
                    const btn = $("#submit-btn");
                    btn.prop('disabled', true);
                    const errorAlert = function(erros) {
                        btn.prop('disabled', false);
                    };

                    const updateUser = function(avatarPath) {
                        settingsApi.patchUser({
                            name: form.name.value,
                            bio: form.bio.value,
                            avatar: avatarPath ? avatarPath : null
                        }, function () {
                            updateLocalstorageUsername(form.name.value);
                            window.location = "/settings"
                        }, errorAlert);
                    };

                    const file = $("#image").prop('files')[0];
                    if (file) {
                        const imageData = new FormData();
                        imageData.append('image', file);
                        settingsApi.uploadAvatar(imageData, function (res) {
                            updateUser(res.path)
                        }, errorAlert);
                    } else {
                        updateUser(undefined)
                    }
                }
            });
        });
    </script>
    {{template "analytics"}}
</body>
</html>